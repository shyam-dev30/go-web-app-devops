name: cicd
on:
 push:
  branches:
   - dev
  paths-ignore:
   - 'helm/**'
   - 'k8s/**'
   - 'README.md'

jobs:
 build:
  runs-on: ubuntu-latest
  steps:
   - name: checkout repo
     uses: actions/checkout@v4

   - name: set up go 1.22
     uses: actions/setup-go@v2
     with:
      go-version: 1.22
   - name: build
     run: go build -o go-web-app
    
   - name: test
     run: go test ./...
 code-quality:
  runs-on: ubuntu-latest
  steps:
   - name: checkout repo
     uses: actions/checkout@v4
   - name: run go-cli lint
     uses: golangci/golangci-lint-action@v6
     with:
      version: v1.56.2
 push:
  runs-on: ubuntu-latest
  needs: build
  steps:
   - name: checkout repo
     uses: actions/checkout@v4

   - name: set docker img
     uses: docker/setup-builx-action@v1

   - name: login to dockerhub
     uses: docker/login-action@v3
     with:
      username: ${{ secrets.DOCKERHUB_USERNAME }}
      password: ${{ secrets.DOCKERHUB_TOKEN }}

   - name: build and push
     uses: docker/build-push-action@v6
     with:
      context: .
      file: ./Dockerfile
      push: true
      tags: ${{ secrets.DOCKERHUB_USERNAME }}/go-web-app:${{github.run_id}}
 update-new-tag-in-helm-chart:
  runs-on: ubuntu-latest
  needs: push
  steps:
   - name: checkout repo
     uses: actions/checkout@v4
     with:
      token: ${{ secrets.GITHUB_TOKEN }}
   - name: update tag in helm chart
     run: |
      sed -i 's/tag: .*/tag: "${{github.run_id}}"/ helm/go-web-app-chart/values.yaml'

   - name: commit and push changes
     run: |
      git config --global user.email: "shyamsahu3005@gmail.com"
      git config --global user.name: "shyam-dev30"
      git add helm/go-web-chart/values.yaml
      git commit -m "update tag in helm chart"
      git push
